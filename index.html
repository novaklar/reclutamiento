<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novaklar & Hanabi</title>

  <!-- Poppins only -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome (opcional para iconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root{
      --bg: #f6f7f8;
      --card: #ffffff;
      --primary: #0d4c7f;
      --accent: #7fcfda;
      --dark: #080a33;
      --muted: rgba(8,10,51,0.45);
      --glass: rgba(127,207,218,0.12);
      --success: #4caf50;
      --radius: 12px;
      --max-width: 1080px;
      --gap: 14px;
    }

    /* Tipografía única: Poppins */
    * { box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      color: var(--dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      padding-bottom: 48px;
    }

    /* Contenedor centrado con padding mobile-first */
    .wrap{
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 16px;
    }

    /* Header compacto y accesible (simplificado) */
    header.app-header{
      position: sticky;
      top: 0;
      z-index: 60;
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 16px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(8,10,51,0.04);
    }
    header .brand{
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }
    header img.logo{
      height:36px;
      width:auto;
      display:block;
    }
    header .nav-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--primary);
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      font-size:0.95rem;
      cursor:pointer;
      text-decoration:none;
    }
    .btn.secondary{
      background:transparent;
      color:var(--primary);
      border:1px solid rgba(13,76,127,0.12);
    }
    .btn:active{ transform: translateY(1px); }

    /* Subtítulo y título */
    .page-head{
      text-align:center;
      margin: 18px 0 6px;
    }
    h1.page-title{
      margin:0;
      font-size:1.45rem;
      font-weight:700;
      color:var(--dark);
    }
    p.page-sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:0.95rem;
      font-weight:600;
    }

    /* Grid principal: stats + contenido */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      margin-top:14px;
    }

    /* Stats cards (responsive) */
    .stats{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: 0 6px 18px rgba(8,10,51,0.06);
      border: 1px solid rgba(8,10,51,0.03);
    }
    .stat .label{ font-size:0.85rem; color:var(--muted); }
    .stat .value{ font-weight:700; font-size:1.2rem; color:var(--primary); margin-top:6px; }

    /* Controls: calculator + refresh (search removed) */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .controls-left{
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
    }

    /* Calculator container (nuevo) */
    .calculator-card{
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(8,10,51,0.06);
      border: 1px solid rgba(8,10,51,0.03);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width: 220px;
    }
    .calculator-top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .calculator{
      display:flex;
      gap:10px;
      align-items:center;
      width:100%;
    }
    .amount{
      display:flex;
      align-items:center;
      gap:8px;
      background:transparent;
      border-radius:10px;
      padding:8px;
      border:1px solid rgba(8,10,51,0.04);
      flex:1;
    }
    .amount input{
      border:0;
      outline:0;
      font-weight:600;
      font-size:1rem;
      width:140px;
      text-align:right;
      background:transparent;
    }
    .calc-btn{
      background:var(--success);
      color:white;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Calculator results (inside same container, just below) */
    #calculator-results {
      margin-top: 6px;
      width:100%;
    }

    /* Legend */
    .legend{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:8px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:0.88rem;
    }
    .legend .dot{
      width:12px;
      height:12px;
      border-radius:50%;
    }
    .legend .dot.primary{ background:var(--primary); }
    .legend .dot.secondary{ background:var(--accent); }

    /* Summary: table on desktop, cards on small screens */
    .summary{
      margin-top:8px;
    }
    table.summary-table{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
      border-radius:10px;
      overflow:hidden;
      box-shadow: 0 8px 20px rgba(8,10,51,0.06);
      border:1px solid rgba(8,10,51,0.03);
    }
    table.summary-table thead th{
      background: linear-gradient(90deg,var(--primary), #0b6aa6);
      color:white;
      text-align:left;
      padding:12px;
      font-weight:600;
      font-size:0.9rem;
    }
    table.summary-table tbody td{
      padding:12px;
      border-bottom:1px solid rgba(8,10,51,0.04);
      font-size:0.92rem;
    }
    .badge{
      display:inline-block;
      padding:6px 8px;
      border-radius:8px;
      font-weight:700;
      font-size:0.82rem;
      min-width:64px;
      text-align:center;
    }
    .badge.real{ background:var(--glass); color:var(--primary); border:1px solid rgba(127,207,218,0.28); }
    .badge.pay{ background:rgba(13,76,127,0.08); color:var(--primary); border:1px solid rgba(13,76,127,0.16); }

    /* Mobile-friendly cards for small widths */
    .cards-list{ display:none; gap:12px; }
    .card-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .card-row .meta{ color:var(--muted); font-size:0.85rem; }

    /* Utilities */
    .muted{ color:var(--muted); }
    .center{ text-align:center; }

    /* No-data / loading / error */
    .status {
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      background:var(--card);
      border:1px dashed rgba(8,10,51,0.04);
      color:var(--muted);
      text-align:center;
    }

    /* Responsive rules (mobile-first) */
    @media (max-width: 880px){
      .stats{ grid-template-columns: repeat(2,1fr); }
      header img.logo{ height:32px; }
      .card .value{ font-size:1.05rem; }
      .amount input{ width:120px; }
    }
    @media (max-width: 640px){
      .grid{ gap:10px; }
      .stats{ grid-template-columns: 1fr; }
      .controls{ flex-direction:column; align-items:stretch; gap:10px; }
      .controls-left{ width:100%; justify-content:space-between; }
      .calculator{ width:100%; }
      .amount input{ width:100%; text-align:left; }
      table.summary-table thead{ display:none; }
      table.summary-table tbody tr{ display:block; border-bottom: 10px solid transparent; margin-bottom:8px; }
      table.summary-table tbody td{
        display:flex;
        justify-content:space-between;
        padding:10px;
        border-bottom:1px solid rgba(8,10,51,0.04);
      }
      .cards-list{ display:flex; flex-direction:column; }
      .summary-table{ display:none; }
      .card{
        padding:10px;
      }
    }
  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <img class="logo" alt="Novaklar" src="https://raw.githubusercontent.com/novaklar/web/refs/heads/main/novaklar1.svg" />
    </div>

    <nav class="nav-actions" role="navigation" aria-label="Acciones">
      <a class="btn secondary" href="https://novaklar.github.io/Personal/" aria-label="Regresar">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
        Regresar
      </a>
    </nav>
  </header>

  <main class="wrap" role="main">
    <div class="page-head" aria-hidden="true">
      <h1 class="page-title">DTO reclutamiento</h1>
      <p class="page-sub">Novaklar &amp; Hanabi</p>
    </div>

    <section class="grid" aria-live="polite">
      <!-- Stats -->
      <div class="stats" id="stats-bar" style="display:none">
        <div class="card stat">
          <div class="label">Reclutadoras</div>
          <div id="recruiters-count" class="value">0</div>
        </div>
        <div class="card stat">
          <div class="label">Total Afiliados</div>
          <div id="total-recruited" class="value">0</div>
        </div>
        <div class="card stat">
          <div class="label">Porcentaje Total</div>
          <div id="total-percentage" class="value">100%</div>
        </div>
      </div>

      <!-- Controls: calculator container + refresh (search removed) -->
      <div>
        <div class="controls">
          <div class="controls-left">
            <!-- Calculator now inside its own container -->
            <div class="calculator-card" id="calculator-section" style="display:none" aria-labelledby="calculator-title">
              <div class="calculator-top">
                <div id="calculator-title" style="font-weight:700; color:var(--primary)">Calculadora de reparto</div>
                <div class="muted" style="font-size:0.9rem">Distribución por porcentaje</div>
              </div>

              <div class="calculator" role="group" aria-label="Calculadora de reparto">
                <div class="amount">
                  <span class="muted" aria-hidden="true">$</span>
                  <input id="total-amount" inputmode="numeric" pattern="[0-9]*" placeholder="Monto a repartir" aria-label="Monto total a repartir" />
                </div>
                <button id="calculate-btn" class="calc-btn" style="display:none" aria-controls="calculator-results">
                  <i class="fas fa-calculator" aria-hidden="true"></i>
                  Calcular
                </button>
              </div>

              <!-- Results aparecerán dentro de este mismo contenedor, justo debajo -->
              <div id="calculator-results" style="display:none"></div>
            </div>
          </div>

          <div>
            <button id="refresh-btn" class="btn" title="Actualizar ahora">
              <i id="refresh-icon" class="fas fa-sync-alt" aria-hidden="true"></i>
              <span id="refresh-text">Actualizar</span>
            </button>
          </div>
        </div>

        <div class="legend" id="legend" style="display:none" aria-hidden="false">
          <div style="display:flex;align-items:center;gap:8px;"><span class="dot primary"></span><small>Porcentaje Real (decimales)</small></div>
          <div style="display:flex;align-items:center;gap:8px;"><span class="dot secondary"></span><small>Porcentaje Pagable (suma 100%)</small></div>
        </div>
      </div>

      <!-- Summary -->
      <div class="summary" id="summary-container" style="display:none">
        <!-- Table for desktop -->
        <table class="summary-table" aria-label="Resumen de reclutadoras">
          <thead>
            <tr>
              <th>#</th>
              <th>Reclutadora</th>
              <th>Total Afiliados</th>
              <th>Porcentaje Real</th>
              <th>Porcentaje Pagable</th>
              <th>Diferencia</th>
            </tr>
          </thead>
          <tbody id="summary-body">
            <!-- filas generadas por JS -->
          </tbody>
        </table>

        <!-- Cards for mobile -->
        <div class="cards-list" id="summary-cards" aria-hidden="true">
          <!-- generadas por JS -->
        </div>
      </div>

      <div id="loading" class="status" role="status">Cargando datos…</div>
      <div id="error" class="status" style="display:none" role="alert"></div>
      <div id="no-data" class="status" style="display:none">No hay datos disponibles</div>

      <div id="last-updated" class="muted center" style="margin-top:10px;"></div>
    </section>
  </main>

  <script>
    /* Configuración: SPREADSHEET_ID actualizado según la URL proporcionada */
    const SPREADSHEET_ID = '12KqUWKpU4OsP77V1gfFDDiCbB4eQFQDdR8sJ_qLk3rI';
    const SHEET_NAME = 'Form Responses 1';
    const RANGE = 'A:F';
    const UPDATE_INTERVAL = 5 * 60 * 1000;

    /* Elementos */
    const summaryBody = document.getElementById('summary-body');
    const summaryCards = document.getElementById('summary-cards');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const lastUpdatedEl = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshIcon = document.getElementById('refresh-icon');
    const noDataEl = document.getElementById('no-data');
    const statsBar = document.getElementById('stats-bar');
    const recruitersCountEl = document.getElementById('recruiters-count');
    const totalRecruitedEl = document.getElementById('total-recruited');
    const totalPercentageEl = document.getElementById('total-percentage');
    const calculatorSection = document.getElementById('calculator-section');
    const totalAmountInput = document.getElementById('total-amount');
    const calculateBtn = document.getElementById('calculate-btn');
    const calculatorResults = document.getElementById('calculator-results');
    const legend = document.getElementById('legend');

    let summaryData = [];
    const numberFormatter = new Intl.NumberFormat('es-ES');

    /* Utilidades */
    function normalizeName(name){
      if(!name) return '';
      return name.toString().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9\s]/g,'').trim();
    }
    function formatNumber(n){ return numberFormatter.format(n); }

    function spinOn(btn){
      refreshIcon.style.transition = 'transform .9s linear';
      refreshIcon.style.transform = 'rotate(360deg)';
      setTimeout(()=> { refreshIcon.style.transform = ''; }, 900);
    }

    /* Cálculos de porcentaje y ajuste */
    function calculatePercentages(recruitersData){
      const totalAffiliates = recruitersData.reduce((s,r)=>s+r.affiliateCount,0);
      if(totalAffiliates === 0) return [];
      const withReal = recruitersData.map(r => {
        const real = (r.affiliateCount / totalAffiliates) * 100;
        return {...r, realPercentage: real, roundedPercentage: Math.round(real)};
      });

      // Ajuste para sumar 100
      let totalRounded = withReal.reduce((s,r)=>s+r.roundedPercentage,0);
      let diff = 100 - totalRounded;
      if(diff !== 0){
        const byPriority = withReal.map(r => ({...r, frac: r.realPercentage - r.roundedPercentage}))
          .sort((a,b)=> Math.abs(b.frac) - Math.abs(a.frac));
        const sign = Math.sign(diff);
        let i = 0;
        while(diff !== 0){
          byPriority[i % byPriority.length].roundedPercentage += sign;
          diff -= sign;
          i++;
        }
        withReal.forEach(w => {
          const p = byPriority.find(b => b.name === w.name);
          if(p) w.roundedPercentage = p.roundedPercentage;
        });
      }

      return withReal.map(i => {
        const difference = i.roundedPercentage - i.realPercentage;
        return {
          ...i,
          realPercentageFormatted: i.realPercentage.toFixed(2) + '%',
          roundedPercentageFormatted: i.roundedPercentage + '%',
          difference,
          differenceFormatted: (difference > 0 ? '+' : '') + difference.toFixed(2) + '%'
        };
      });
    }

    function consolidateData(rows){
      const map = new Map();
      let totalAffiliates = 0;
      rows.forEach(row=>{
        if(!row.c || !Array.isArray(row.c)) return;
        const recruiterCell = row.c[1];
        const recruitedCell = row.c[2];
        const recruiterName = recruiterCell ? String(recruiterCell.v || recruiterCell.f || '').trim() : '';
        const recruitedName = recruitedCell ? String(recruitedCell.v || recruitedCell.f || '').trim() : '';

        if(recruiterName && recruitedName){
          totalAffiliates++;
          const key = normalizeName(recruiterName);
          if(map.has(key)) map.get(key).affiliateCount++;
          else map.set(key, { name: recruiterName, affiliateCount: 1 });
        }
      });

      const recruiters = Array.from(map.values()).sort((a,b)=> b.affiliateCount - a.affiliateCount);
      const summary = calculatePercentages(recruiters);
      return { summary, stats: { totalRecruiters: map.size, totalAffiliates } };
    }

    /* Render summary: table + mobile cards */
    function renderSummary(data){
      summaryData = data.summary;
      if(summaryData.length === 0){
        noDataEl.style.display = 'block';
        document.getElementById('summary-container').style.display = 'none';
        return;
      }

      recruitersCountEl.textContent = data.stats.totalRecruiters;
      totalRecruitedEl.textContent = formatNumber(data.stats.totalAffiliates);
      const totalRounded = data.summary.reduce((s,i)=>s+i.roundedPercentage,0);
      totalPercentageEl.textContent = totalRounded + '%';

      statsBar.style.display = 'grid';
      calculatorSection.style.display = 'flex';
      calculateBtn.style.display = 'inline-flex';
      legend.style.display = 'flex';
      document.getElementById('summary-container').style.display = 'block';
      noDataEl.style.display = 'none';

      drawTable(summaryData);
      drawCards(summaryData);
    }

    function drawTable(list){
      summaryBody.innerHTML = '';
      list.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><strong>${escapeHtml(r.name)}</strong></td>
          <td>${formatNumber(r.affiliateCount)}</td>
          <td><span class="badge real">${r.realPercentageFormatted}</span></td>
          <td><span class="badge pay">${r.roundedPercentageFormatted}</span></td>
          <td>${r.differenceFormatted}</td>
        `;
        summaryBody.appendChild(tr);
      });
    }

    function drawCards(list){
      summaryCards.innerHTML = '';
      list.forEach((r) => {
        const c = document.createElement('div');
        c.className = 'card';
        c.innerHTML = `
          <div class="card-row">
            <div>
              <div style="font-weight:700">${escapeHtml(r.name)}</div>
              <div class="meta">${formatNumber(r.affiliateCount)} afiliad${r.affiliateCount === 1 ? 'o' : 'os'}</div>
            </div>
            <div style="text-align:right; min-width:86px;">
              <div class="badge real" style="display:inline-block">${r.realPercentageFormatted}</div>
              <div style="height:6px"></div>
              <div class="badge pay" style="display:inline-block; margin-top:6px">${r.roundedPercentageFormatted}</div>
            </div>
          </div>
        `;
        summaryCards.appendChild(c);
      });
    }

    function escapeHtml(text){
      return (text+'').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* Calculadora: distribución y ajuste */
    function calculateDistribution(totalAmount){
      if(!summaryData || summaryData.length === 0) return [];
      const dist = summaryData.map(r => {
        const amount = Math.round((totalAmount * r.roundedPercentage) / 100);
        return { name: r.name, percentage: r.roundedPercentage, amount };
      });

      let totalDistributed = dist.reduce((s,i)=>s+i.amount,0);
      let diff = totalAmount - totalDistributed;
      if(diff !== 0){
        const byPct = [...dist].sort((a,b)=> b.percentage - a.percentage);
        const sign = Math.sign(diff);
        let i = 0;
        while(diff !== 0){
          byPct[i % byPct.length].amount += sign;
          const target = dist.find(d => d.name === byPct[i % byPct.length].name);
          target.amount = byPct[i % byPct.length].amount;
          diff -= sign;
          i++;
        }
      }
      return dist;
    }

    function showCalculatorResults(totalAmount){
      const distribution = calculateDistribution(totalAmount);
      if(distribution.length === 0){
        calculatorResults.style.display = 'none';
        return;
      }
      const totalDistributed = distribution.reduce((s,i)=>s+i.amount,0);
      let html = '<div class="card" style="padding:8px"><table style="width:100%">';
      html += '<thead><tr><th style="text-align:left">Reclutadora</th><th style="text-align:right">Porcentaje</th><th style="text-align:right">Monto</th></tr></thead><tbody>';
      distribution.forEach(d => {
        html += `<tr><td>${escapeHtml(d.name)}</td><td style="text-align:right">${d.percentage}%</td><td style="text-align:right"><strong>$${formatNumber(d.amount)}</strong></td></tr>`;
      });
      html += `</tbody></table><div style="text-align:right; margin-top:8px; font-weight:700">Total: $${formatNumber(totalDistributed)}</div></div>`;
      calculatorResults.innerHTML = html;
      calculatorResults.style.display = 'block';
    }

    /* Formato del input monto y eventos */
    totalAmountInput.addEventListener('input', (e) => {
      const raw = String(e.target.value).replace(/\D/g,'');
      if(raw === '') { e.target.value = ''; return; }
      e.target.value = formatNumber(parseInt(raw,10));
    });

    calculateBtn.addEventListener('click', () => {
      const raw = String(totalAmountInput.value).replace(/\D/g,'');
      if(raw === '') {
        calculatorResults.style.display = 'none';
        return;
      }
      const amount = parseInt(raw,10);
      if(isNaN(amount) || amount <= 0) return;
      showCalculatorResults(amount);
      // Scroll suave para móviles: aseguramos los resultados estén visibles justo debajo
      calculatorResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    totalAmountInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') calculateBtn.click();
    });

    /* Responsive: mostrar u ocultar tabla/cards según ancho */
    function adjustView(){
      const mobile = window.innerWidth <= 640;
      document.querySelector('.summary-table').style.display = mobile ? 'none' : '';
      summaryCards.style.display = mobile ? '' : 'none';
      summaryCards.setAttribute('aria-hidden', !mobile);
    }
    window.addEventListener('resize', () => { setTimeout(adjustView, 120); });

    /* Carga de datos desde Google Sheets */
    async function loadDataFromSheets(){
      try{
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        noDataEl.style.display = 'none';
        document.getElementById('summary-container').style.display = 'none';
        calculatorResults.style.display = 'none';
        spinOn(refreshBtn);

        refreshBtn.disabled = true;
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=${RANGE}&t=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error('Error ' + res.status);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf('(')+1).slice(0, -2));
        if(!json.table?.rows) throw new Error('Estructura de datos inesperada');
        const data = consolidateData(json.table.rows);
        renderSummary(data);
        adjustView();

        loadingEl.style.display = 'none';
        lastUpdatedEl.textContent = 'Actualizado: ' + new Date().toLocaleString('es-ES', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      } catch(err){
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'Error al cargar datos: ' + (err.message || err);
        console.error(err);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    /* Auto-refresh */
    let autoInterval;
    function startAutoRefresh(){
      loadDataFromSheets();
      if(autoInterval) clearInterval(autoInterval);
      autoInterval = setInterval(loadDataFromSheets, UPDATE_INTERVAL);
    }

    refreshBtn.addEventListener('click', () => {
      startAutoRefresh();
    });

    // Inicial
    startAutoRefresh();
  </script>
</body>
</html>
